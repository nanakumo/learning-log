# Today I Learned

## ユーザーと権限管理

### ユーザー管理

ユーザーの作成：

```sql
CREATE USER test_user WITH PASSWORD `pass1`;
```

| オプション   | 説明                                 |
| ------------ | ------------------------------------ |
| SUPERUSER    | 管理者権限を持つユーザーを作成       |
| CREATEDB     | 新しいデータベースを作成できる       |
| CREATEROLE   | 新しいロールを作成できる             |
| LOGIN        | ログイン可能（デフォルト）           |
| NOCREATEDB   | データベース作成を禁止（デフォルト） |
| NOCREATEROLE | ロール作成を禁止（デフォルト）       |

権限の変更：
例：

```sql
-- 権限の付与
ALTER USER test_user WITH CREATEDB;
-- 権限の削除
ALTER USER test_admin WITH NOSUPERUSER;
```

ユーザーの削除：

```sql
DROP USER test_user;
```

注意点：

- ユーザーが DB 内のオブジェクト（スキーマやテーブルなど）を所有している場合、そのままは削除出来ません。以下のエラーが出ています。

```sql
learning_log_db=# DROP USER test_user;
ERROR:  role "test_user" cannot be dropped because some objects depend on it
DETAIL:  privileges for schema public
owner of sequence accounts_account_id_seq
owner of table accounts
```

その場合、事前に所有するオブジェクトを削除するか、別のユーザーに移譲する必要があります。

例：test_user が所有するオブジェクトを admin_user に移譲

-- 特定のオブジェクト（public.accounts テーブル）の所有権を test_admin に移譲

```sql
ALTER TABLE accounts OWNER TO test_admin;
```

-- test_user が所有するすべての権限・オブジェクトを一括で test_admin に移譲

```sql
REASSIGN OWNED BY test_user TO test_admin;
```

- 補足：所有者を確認する方法
  `\dt table名`

ユーザーのロール情報の確認方法：

```sql
SELECT rolname, rolsuper, rolcreatedb, rolcreaterole, rolcanlogin FROM pg_roles;
```

実行してみると、以下のように出ています。

```sql
           rolname           | rolsuper | rolcreatedb | rolcreaterole | rolcanlogin
-----------------------------+----------+-------------+---------------+-------------
 zhao                        | t        | t           | t             | t
 pg_database_owner           | f        | f           | f             | f
 pg_read_all_data            | f        | f           | f             | f
 pg_write_all_data           | f        | f           | f             | f
 pg_monitor                  | f        | f           | f             | f
 pg_read_all_settings        | f        | f           | f             | f
 pg_read_all_stats           | f        | f           | f             | f
 pg_stat_scan_tables         | f        | f           | f             | f
 pg_read_server_files        | f        | f           | f             | f
 pg_write_server_files       | f        | f           | f             | f
 pg_execute_server_program   | f        | f           | f             | f
 pg_signal_backend           | f        | f           | f             | f
 pg_checkpoint               | f        | f           | f             | f
 pg_use_reserved_connections | f        | f           | f             | f
 pg_create_subscription      | f        | f           | f             | f
 test_admin                  | f        | t           | f             | t
```

pg から始まるロールは、デフォルトロールです。
実際の使い方：

```sql
-- 読み取り専用のユーザーを作りたい
GRANT pg_read_all_data TO test_read_only_user;
-- 監視ツール用のユーザーを作りたい
GRANT pg_monitor TO test_monitor_user;
```

### 権限管理

基本構文

```sql
GRANT 権限リスト ON オブジェクト名 TO ユーザー;
```

例：

```sql
GRANT SELECT, INSERT ONv accounts TO test_user;
```

全てのロールを付与します

```sql
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO test_user;
```

DB 接続権限の付与：

```sql
GRANT CONNECT ON DATABASE learning_log_db TO test_user;
```

複数のユーザーに同じ権限を一括で管理したい：

```sql
-- roleを作成する
CREATE ROLE developer;
-- roleに権限を付与する
GRANT SELECT, INSERT, UPDATE ON accounts TO developer;
-- userにdeveloper権限を付与する
GRANT developer TO test_user;
```

権限管理：

```sql
-- insert権限を撤回する
REVOKE INSERT ON accounts FROM test_user;
-- 全ての権限を撤回する
REVOKE ALL PRIVILEGES ON accounts FROM test_user;
```

## pg_backup と pg_restore

### backup の種類

1. 論理バックアップ -> SQL dump (table 単位)
2. 物理バックアップ -> ディスク単位のフルコピー
3. PITR -> 障害復元に必須、特定の時点に復元可能

#### pg_dump

DB 全体、特定のテーブル、またはスキーマをエクスポートできます。

例：

```
-- export folder 作成
mkdir backup
-- DB全体をバックアップします
pg_dump -h localhost -U postgres -d learning_log_db -F c -f backup/learning_log_db_backup.dump`
-- 特定のテーブルをバックアップします
pg_dump -h localhost -U postgres -d learning_log_db -t accounts -F c -f backup/accounts_backup.dump
```

- -F: エクスポートするフォーマット

#### pg_restore

リストアしたい場合、新しい DB を作成する必要があります。
`createdb -U postgres mydatabase`
pg_backupでバックアップしたdump fileを新しく作られたDBに移動します。
`pg_restore -h localhost -U postgres -d mydatabase_restored -F c backup/learning_log_db_backup.dump`