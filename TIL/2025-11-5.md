# Today I Learned

## ログ管理

local 環境でのログ管理に関する学習メモです。本番のログ管理はクラウドサービスで管理されることが多いですが、基礎知識も重要なので、learning log としてまとめてみました。

### ログ設定

PostgreSQL のログ設定は`postgresql.conf`ファイルで行います。全ての関連設定はこのファイルで確認できます。

## trouble shooting

トラブルシューティングとは、問題が発生した際に、その原因を特定し、解決するための体系的なプロセスです。

### 一般的なエラーと対策

- 接続エラー

  - **エラー例**:
    `FATAL: password authentication failed for user "postgres"`

  - **原因**:
    ユーザーの認証情報が正しくない、または `pg_hba.conf` の設定に誤りがある。

  - **対策**:

    - `pg_hba.conf` を確認
      （例: `host all all 127.0.0.1/32 md5` など）

    - パスワードを変更
      ```sql
      ALTER USER postgres WITH PASSWORD 'newpassword';
      ```

- 権限エラー

  - **エラー例**:
    `ERROR: permission denied for table employees`

  - **原因**:
    クエリを実行するユーザーに
    `employees` テーブルへの権限がない。

  - **対策**:
    ```sql
    GRANT SELECT ON employees TO username;
    ```

- データベースのロック

  - **エラー例**:
    `ERROR: deadlock detected`

  - **原因**:
    複数のトランザクションが互いにロックを待ち続けている。

  - **対策**:

    ```sql
    -- ロック状態を確認
    SELECT * FROM pg_locks;

    -- 必要ならロックを解除
    SELECT pg_terminate_backend(pid)
    FROM pg_stat_activity
    WHERE datname = 'your_db';
    ```

## ログ確認

実践：accounts table に対して、誤ったクエリを実行して、実際にログを見てみます。

下記のクエリを実行します。

```sql
SELECT fullname FROM accounts;
```

実行すると、下記のエラーが出ています。

```
ERROR:  column "fullname" does not exist
行 1: SELECT fullname FROM accounts;
```

`tail -f /opt/homebrew/var/log/postgresql@16.log`でログを確認すると、下記のログが出ています。

```
2025-11-05 13:11:04.747 JST [10625] ERROR:  column "fullname" does not exist at character 8
2025-11-05 13:11:04.747 JST [10625] STATEMENT:  SELECT fullname FROM accounts;
```

## PostgreSQL の設定ファイル

### postgres.conf

`postgres.conf`ファイルは、PostgreSQL のメイン設定ファイルです。`SHOW config_file;`のコマンドで保存場所を確認できます。

重要な設定項目は以下です。

1. Connection Settings
   - listen_addresses = 'localhost' # 接続を受け付ける IP アドレス。
   - Port
   - max_connections = 100 # 同時に接続できる最大値。
2. RESOURCE USAGE (except WAL)
   - shared_buffers = 128MB # データをキャッシュするために使うメモリ領域のサイズ。

## pg_hba.conf

`pg_hba.conf`ファイルは、PostgreSQL のメイン設定ファイルです。`SHOW hba_file;`のコマンドで保存場所を確認できます。

ファイル構造は下記です。

- **TYPE**：接続の種類（`local` / `host` など）
- **DATABASE**：対象のデータベース（`all` で全てを指定可能）
- **USER**：接続を許可するユーザー
- **ADDRESS**：接続元の IP アドレス（`local` の場合は不要）
- **METHOD**：認証方式（`scram-sha-256` / `md5` / `trust` など）

