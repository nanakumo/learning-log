# パフォーマンスチューニング

## index の種類と作成（B-tree, Hash, GIN, GiST）

index は、データ検索を高速化するためのデータ構造です。本の索引のように。目的のデータに素早くアクセスできるようにします。

- メリット：クエリのパフォーマンス向上
- デメリット：データ挿入・更新時にオーバーヘッドが発生

### index の種類と使用方法

- B-tree index

  - 最も一般的な index。=, <, >, <=, >= に最適。
  - 使用例：`CREATE INDEX idx_employees_age ON employees(age);`
  - 適用シナリオ：年齢での検索やソート

- Hash index

  - = に特化。**範囲検索は不可。**
  - 使用例：`CREATE INDEX idx_employees_position_hash ON employees USING hash(position);`
  - 適用シナリオ：完全一致の検索

- GIN

  - 配列、JSONB、全文検索に強い。
  - （JSONB データ型を持つ場合）`CREATE INDEX idx_documents_content_gin ON documents USING gin(content);`

- GiST
  - 空間データ、近似検索に適している。
  - 適用シナリオ：位置情報

## index の削除

構文：`DROP INDEX IF EXISTS idx_employees_age;`

## クエリプランの解析（EXPLAIN, EXPLAIN ANALYZE）

クエリプランとは、POSTGRESQL が SQL クエリを実行する際に、どのようにデータを取得するかを決定する手順のことです。

## EXPLAIN

EXPLAIN は、クエリを実行する前に、クエリプランを表示するコマンドです。

使用例：`EXPLAIN SELECT * FROM employees WHERE age > 30;`

実行結果：

```
"Seq Scan on employees  (cost=0.00..1.05 rows=1 width=532)"
"  Filter: (age > 30)"
```

注意点：データ挿入・更新後、`ANALYZE`を実行してデータ情報を再収集する必要があります。

## EXPLAIN ANALYZE

`EXPLAIN ANALYZE`は、実際にクエリを実行して、その実行時間や各ステップの詳細な情報を提供します。

例：

```sql
"Seq Scan on employees  (cost=0.00..1.05 rows=1 width=532)"
```

## 実行計画

PostgreSQL はクエリを実行する際、データを取得するための最適な手順（実行計画）を決定します。

- Seq Scan：テーブル全体を順番にスキャンする方法。
- Index Scan：index を利用して、条件に一致するデータを高速に検索する方法。
- Bitmap Index Scan：複数の index を組み合わせて効率的にデータを取得する方法。
- Nested Loop Join：テーブル結合時、一方のテーブルを一行ずつ処理して、もう一方のテーブルを検索する方法。
